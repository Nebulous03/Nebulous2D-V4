package nebulous.main;

import static org.lwjgl.glfw.GLFW.*;
import static org.lwjgl.opengl.GL11.*;

import nebulous.graphics.Window;
import nebulous.utils.Time;

public abstract class Game {
	
	private String title = "Nebulous2D Game Engine";
	private int width = 1366;
	private int height = 768;
	private Window window = null;
	
	private double framecap = 60;

	public Game(int width, int height, String title) {
		this.title = title;
		this.width = width;
		this.height = height;
		this.window = createWindow();
	}
	
	public void start(){
		tick();
	}
	
	public void stop(){
		glfwTerminate();
	}
	
	private void tick(){
		init();
		
		int frames = 0;
        double frameCounter = 0;
		
		double lastTime = Time.getTime();
		double unprocessedTime = 0;

		while(!glfwWindowShouldClose(window.getWindowID())){
			glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
			
			double startTime = Time.getTime();
            double pastTime = startTime - lastTime;
			lastTime = startTime;
			unprocessedTime += pastTime;
			frameCounter += pastTime;
			
			while(unprocessedTime > framecap){
				render = true;
				unprocessedTime -= framecap;
				if(Window.shouldClose())
					stop();

				game.inputGame(framecap);
				Input.update();
				
				game.updateGame(framecap);

				if(frameCounter >= 1.0){
					Console.println("FPS: " + frames + " Delta: " + pastTime*1000); //TODO: Fix this
					frameCounter = 0;
					frames = 0;
				}
			}
			
			if(render){
				game.renderGame(renderEngine);
                Window.render();
				frames++;
			}
			
			else{
				try {
					Thread.sleep(1);
				} catch (InterruptedException e) {
					e.printStackTrace();
				}
			}
			
			
			update();
			render();
			
			glfwSwapBuffers(window.getWindowID());
			glfwPollEvents();
		}
	}
	
	public abstract void init();
	
	public abstract void update();
	
	public abstract void render();
	
	private Window createWindow(){
		Window window = new Window().createWindow(width, height, title);
		window.setVisable(true);
		return window;
	}

}
